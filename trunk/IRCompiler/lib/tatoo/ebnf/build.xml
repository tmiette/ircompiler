<?xml version="1.0"?>
<project name="tatoo-ebnf" default="all" basedir=".">
	<!-- need cc, runtime and regex -->
	
	<!-- global properties -->
	<property name="lib" location="../lib"/>
	<property name="jar" value="tatoo.jar"/>
	<property name="jar-runtime" value="tatoo-runtime.jar"/>
	<property name="target" value="1.5"/>
	<property name="debug" value="true"/>
	<property name="velocity-jar" value="velocity/velocity-dep-1.4.jar"/>
	<property name="validating" value="false"/>
	<property name="flat-src-zip" value="flat-src.zip"/>
	
	<!-- local properties -->
	<property name="source" value="1.5"/>
	<property name="src" location="src"/>
	<property name="gen-src" location="gen-src"/>
	<property name="classes" location="classes"/>
	<property name="velocity-path" value="${lib}/${velocity-jar}"/>
	<property name="jar-path" value="${lib}/${jar}"/>
	<property name="logfile" location="log.xml"/>
	<property name="packagePrefix" value="fr.umlv.tatoo.cc.lexer.ebnf"/>
	<property name="jar-rt-path" value="${lib}/${jar-runtime}"/>
	
	<target name="all" depends="jar"/>
	
	<target name="generate">
		<!-- because taskdef provides update of tatoo.jar which need deletion first -->
		<tempfile property="tmp-tatoo" suffix="-tmp.jar" destdir="." deleteOnExit="true"/>
		<copy file="${jar-path}" tofile="${tmp-tatoo}"/>
		<taskdef name="lexer" classname="fr.umlv.tatoo.cc.lexer.main.LexerTask" classpath="${tmp-tatoo}:${velocity-path}"/>
		<taskdef name="parser" classname="fr.umlv.tatoo.cc.parser.main.ParserTask" classpath="${tmp-tatoo}:${velocity-path}"/>
		<taskdef name="tools" classname="fr.umlv.tatoo.cc.tools.main.ToolsTask" classpath="${tmp-tatoo}:${velocity-path}"/>
		<lexer destination="${gen-src}" lexerFile="ebnf.xlex" validating="${validating}"
			packageprefix="${packagePrefix}"/>
		<parser destination="${gen-src}" parserFile="ebnf.xpars" parsertype="lalr" validating="${validating}"
		    	  logfile="${logfile}" loglevel="FINE"
			  packageprefix="${packagePrefix}"/>
		<tools destination="${gen-src}" lexerFile="ebnf.xlex" parserFile="ebnf.xpars" toolsFile="ebnf.xtls"
		      validating="${validating}" packageprefix="${packagePrefix}"/>
	</target>
	
	<target name="compile" depends="generate">
		<mkdir dir="${classes}"/>
		<javac target="${target}" source="${source}" debug="${debug}" srcdir="${src}:${gen-src}" destdir="${classes}">
			<classpath path="${jar-rt-path}:${jar-path}"/>
			<compilerarg value="-Xlint:deprecation"/>
			<!-- compilerarg value="-Xlint:unchecked"/ -->
		</javac>
		<copy todir="${classes}">
			<fileset dir="${src}">
				<exclude name="**/*.java"/>
				<exclude name="**/.svn"/>
			</fileset>
			<fileset dir="${gen-src}">
				<exclude name="**/*.java"/>
				<exclude name="**/.svn"/>
			</fileset>
		</copy>
	</target>
	
	<target name="jar" depends="compile,jar-nocompile"/>
	
	<target name="jar-nocompile">
		<tempfile property="tmp-classes" suffix="-classes" destdir="."/>
		<unzip src="${jar-rt-path}" dest="${tmp-classes}"/>
		<jar basedir="${classes}" destfile="${jar-path}" update="true"/>
		<jar basedir="${tmp-classes}" destfile="${jar-path}" update="true"/>	
		<delete dir="${tmp-classes}"/>
	</target>
	
	<target name="clean">
		<delete file="${logfile}"/>
		<delete dir="${classes}"/>
		<delete dir="${gen-src}"/>
		<mkdir dir="${gen-src}"/>
	</target>
	
	<target name="flat-src">
		<zip basedir="${src}" destfile="${lib}/${flat-src-zip}" update="true"/>
		<zip basedir="${gen-src}" destfile="${lib}/${flat-src-zip}" update="true"/>
	</target>
</project>
